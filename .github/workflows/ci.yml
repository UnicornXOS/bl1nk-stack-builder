name: CI Checks

on:
  push:
    branches: [ main, develop ]
    # ตัด docs/README/markdown/metadata ออกจากการ trigger CI หนัก
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'

# กันรันซ้ำระหว่างแก้ PR หรือ push ถี่ ๆ — cancel run เดิม
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ใช้ paths-filter เพื่อเปิดเฉพาะ job ที่เกี่ยวข้องจริง ๆ
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      worker: ${{ steps.filter.outputs.worker }}
      bridge: ${{ steps.filter.outputs.bridge }}
      schema: ${{ steps.filter.outputs.schema }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            worker:
              - 'apps/worker/**'
              - 'config/**'
            bridge:
              - 'apps/bridge/**'
            schema:
              - 'packages/schema/**'

  verify-structure:
    name: Verify Project Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: chmod +x scripts/verify_structure.sh
      - run: ./scripts/verify_structure.sh

  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.worker == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          python -m pip install --upgrade pip
          pip install -r apps/worker/requirements.txt
          pip install black isort ruff mypy
      - run: python -m py_compile apps/worker/app/main.py
      - run: black --check --diff apps/worker/
      - run: isort --check-only --diff apps/worker/
      - run: ruff check apps/worker/
      - run: ruff format --check apps/worker/
      - run: mypy apps/worker/ --ignore-missing-imports || true

  typescript-quality:
    name: TypeScript Code Quality
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.bridge == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - uses: pnpm/action-setup@v2
        with:
          version: '8'
      - run: pnpm install --prefix apps/bridge
      - run: npm run typecheck --prefix apps/bridge
      - run: npm run lint:check --prefix apps/bridge
      - run: npm run format:check --prefix apps/bridge
      - run: npm run build --prefix apps/bridge

  openapi-validation:
    name: OpenAPI Schema Validation
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.schema == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install -g @stoplight/spectral-cli
      - run: spectral lint packages/schema/openapi.yaml --format stylish

  python-tests:
    name: Python Tests (unit)
    runs-on: ubuntu-latest
    needs: [python-quality]
    if: always() && needs.changes.outputs.worker == 'true'
    services:
      redis:
        image: redis:7
        ports: [ '6379:6379' ]
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: bl1nk_test
        ports: [ '5432:5432' ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          python -m pip install --upgrade pip
          pip install -r apps/worker/requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx
      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bl1nk_test
          REDIS_URL: redis://localhost:6379/0
          ENVIRONMENT: testing
        run: |
          cd apps/worker
          pytest ../tests/ -v --cov=app --cov-report=xml
      - uses: codecov/codecov-action@v3
        with:
          file: ./apps/worker/coverage.xml
          flags: python
          name: python-coverage
