name: CD Pipeline

# ทำงานเฉพาะหลัง CI ผ่านบน main (ไม่ยิงตรงทุก push)
on:
  workflow_run:
    workflows: [ "CI Checks" ]
    types: [ "completed" ]
    branches: [ "main" ]

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  precheck:
    name: Ensure CI succeeded
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - run: echo "CI passed. Proceeding to CD."

  database-migrations:
    name: Database Migrations
    runs-on: ubuntu-latest
    needs: [precheck]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - run: |
          echo "Testing migration 001..."
          psql "${{ secrets.DEPLOY_DB_DSN }}" -f sql/migrations/001_create_tables.sql
          echo "Testing migration 002..."
          psql "${{ secrets.DEPLOY_DB_DSN }}" -f sql/migrations/002_add_indexes.sql

  integration-tests:
    name: Integration Tests (smoke)
    runs-on: ubuntu-latest
    needs: [database-migrations]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - uses: pnpm/action-setup@v2
        with:
          version: '8'
      - run: |
          python -m pip install --upgrade pip
          pip install -r apps/worker/requirements.txt
          pnpm install --prefix apps/bridge
      - name: Start FastAPI server
        env:
          ENVIRONMENT: testing
        run: |
          cd apps/worker
          uvicorn app.main:app --host 127.0.0.1 --port 8000 &
          sleep 10
      - name: Smoke endpoints
        run: |
          curl -f http://localhost:8000/health
          curl -f -X POST http://localhost:8000/webhook/poe \
            -H "Content-Type: application/json" \
            -d '{"source":"poe","external_id":"test-123","user_id":"test-user","message":"test message"}'

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [integration-tests]
    steps:
      - uses: actions/checkout@v4
      - run: |
          pip install bandit
          bandit -r apps/worker/ -f json -o bandit-report.json || true
      - uses: returntocorp/semgrep-action@v1
        with:
          config: auto
          generateSarif: "1"
      - uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: semgrep.sarif

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [security-scan]
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - uses: pnpm/action-setup@v2
        with:
          version: '8'
      - run: pnpm install --prefix apps/bridge
      - run: |
          pip install pip-tools
          pip-compile apps/worker/requirements.in --output-file apps/worker/requirements.txt
      - name: Build Cloudflare Worker
        run: |
          cd apps/bridge && npm run build
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/bridge
          command: deploy --env production
      - name: Deploy to Vercel (FastAPI)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: apps/worker
          vercel-args: '--prod'

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: always()
    steps:
      - uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#ci-cd'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
